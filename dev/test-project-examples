#!/usr/bin/env bash

set -Eeuo pipefail

COLOR="${COLOR:-true}"

dir="$(dirname "${0}")"

. "${dir}/lib/_"

tmp=$(mktemp) || { echo "No temp file."; exit 1; }
trap 'rm -f "${tmp}"' EXIT

function sources() {
  find "${EXAMPLES_DIR}" -maxdepth 1 -name "*.ts"
}

snapshot="${PROJECT_EXAMPLES_SNAPSHOTS}"
examples=($(sources))
count="$(sources | wc -l)"

i=1
for f in "${examples[@]}"; do
  label="${f##*/${NAME}/}"
  ordinal="$(color_blue "$(printf '%3d' $i)")/$(color_blue $count)."
  msg="${ordinal} Running â€œ$(color_path "${label}")â€"
  echo -en "$(pad_left "${msg}" 58)â€¦"
  pnpm tsx "$f" >> "${tmp}" || { echo "Example â€œ$fâ€ crashed."; exit 1; }
  echo -e "...$(color_green ok) âœ…."
  ((++i))
done


mkdir -p "$(dirname "${snapshot}")"
if [[ -e "${snapshot}" ]]; then
  diff "${snapshot}" "${tmp}"
else
  echo "ğŸ“· Creating project snapshot file at â€œ${snapshot}â€."
fi

cp "${tmp}" "${snapshot}"

show_done 'test:project:examples'
